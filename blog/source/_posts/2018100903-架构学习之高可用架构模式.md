title: 架构学习之高可用架构模式
date: 2018/10/09 15:30:00
tags:
- 架构
categories:
- 学架构

---


### 分布式系统架构CAP定理

> 在一个分布式系统（指互相连接并共享数据的节点的集合）中，当涉及读写操作时，只能保证一致性（Consistence）、可用性（Availability）、分区容错性（Partition Tolerance）三者中的两个，另外一个必须被牺牲。

- 一致性（C）：对某个指定的客户端来说，读操作保证能够返回最新的写操作结果
- 可用性（A）：非故障的节点在合理的时间内返回合理的响应（不是错误和超时的响应）
- 分区容错型（P）：当出现网络分区后，系统能够继续“履行职责”。

> 设计分布式系统架构时必须选择 P（分区容忍），因为网络本身无法做到 100%可靠，有可能出故障，所以分区是一个必然的现象。

- CP：发生分区现象后，有问题的节点不能同步数据，为了保证一致性（C），请求数据时只能返回Error，就不能满足可用性（A）
- AP：发生分区现象后，有问题的节点不能同步数据，为了保证可用性（A），请求数据时只能返回旧数据，就不能满足一致性（C）

<!--more-->

注意：

- CAP 关注的粒度是数据，而不是整个系统。
- CAP 是忽略网络延迟的（数据能够瞬间复制到所有节点）
- 既要考虑分区发生时选择 CP 还是 AP，也要考虑分区没有发生时如何保证 CA。
- 放弃并不等于什么都不做，需要为分区恢复后做准备。

BASE理论：即使无法做到强一致性（CAP），但应用可以采用适合的方式达到最终一致性。

- 基本可用（Basically Available）：分布式系统在出现故障时，允许损失部分可用性，即保证核心可用
- 软状态（Soft State）：允许系统存在中间状态，而该中间状态不会影响系统整体可用性
- 最终一致性（Eventual Consistency）：系统中的所有数据副本经过一定时间后，最终能够达到一致的状态

ACID：数据库管理系统为了保证 “事务” 的正确性而提出来的一个理论。

- Atomicity（原子性）：要么全部完成，要么全部不完成
- Consistency（一致性）：开始和结束后数据库完整型没有破坏
- Isolation（隔离性）：多个并发事务同时对数据进行读写和修改的能力
- Durability（持久性）：事务处理结束后，对数据的修改就是永久的


### 高可用存储架构

#### 双机高可用架构（隐含的假设：主机能够存储所有数据）

- 主备复制（备机仅仅只为备份，并没有提供读写操作，硬件成本上有浪费）
- 主从复制（主机负责读写操作，从机只负责读操作，不负责写操作）
- 主备/主从切换（在原有方案的基础上增加“切换”功能，即系统自动决定主机角色，并完成角色切换）
- 主主复制（两台机器都是主机，互相将数据复制给对方，任意连接一台进行读写操作）

主备切换架构：

- 互连式：主备机直接建立状态传递的渠道
- 中介式：主备机之间不直接连接，而都去连接中介，并且通过中介来传递状态
- 模拟式：主备机之间并不传递任何状态数据，而是备机模拟成一个客户端，向主机发起模拟的读写操作，根据读写操作的响应情况来判断主机的状态

#### 集群式高可用存储架构

##### 数据集群

- 数据集中集群（数据都只能往主机中写，而读操作可以参考主备、主从架构进行灵活多变，如zookeeper集群-ZAB算法）
- 数据分散集群（每台服务器都会负责存储一部分数据，每台服务器又会备份一部分数据，如Hadoop集群）

##### 数据分区

- 集中式：所有的分区都将数据备份到备份中心
- 互备式：每个分区备份另外一个分区的数据
- 独立式：每个分区自己有独立的备份中心


### 计算高可用

- 主备：主机执行所有计算任务，当主机故障时，任务分配器不会自动将计算任务发送给备机
- 主从：任务分配器需要将任务进行分类，确定哪些任务可以发送给主机执行，哪些任务可以发送给备机执行
- 集群
 - 对称集群：负载均衡集群（集群中每个服务器的角色都是一样的，都可以执行所有任务）
 - 非对称集群：集群中的服务器分为多个不同的角色，不同的角色执行不同的任务

### 业务高可用

存储高可用和计算高可用都是为了解决部分服务器故障的场景下，如何保证系统能够继续提供服务。在一些极端场景下，有可能所有服务器都出现故障，此时就需要设计异地多活架构。

> 异地：指地理位置上不同的地方
> 
> 多活：指不同地理位置上的系统都能够提供业务服务

- 同城异区（同一个城市不同区的多个机房）
- 跨城异地（不同城市的多个机房）
- 跨国异地（不同国家的多个机房）

四大设计技巧:

- 保证 “核心” 业务的异地多活
- 保证核心数据 “最终” 一致性
- 采用多种手段同步数据
- 只保证绝大部分用户的异地多活

> 采用多种手段，保证绝大部分用户的核心业务异地多活

四步：

- 业务分级（挑选出核心的业务，只为核心业务设计异地多活）
- 数据分类（识别所有的数据及数据特征）
- 数据同步
- 异常处理

#### 接口级的故障

接口级故障表现为：系统并没有宕机，网络也没有中断，但业务却出现问题了（业务响应缓慢、大量访问超时、大量访问出现异常）

> 优先保证核心业务和优先保证绝大部分用户

解决方案：

- 降级：（应对系统自身的故障）将某些业务或者接口的功能降低，可以是只提供部分功能，也可以是完全停掉所有功能
 - 系统后门降级
 - 独立降级系统
- 熔断：（应对依赖的外部系统故障的情况）壮士断腕，停掉外部依赖的调用
- 限流：（直接拒绝用户）从系统功能优先级的角度考虑如何应对故障，只允许系统能够承受的访问量进来，超出系统访问能力的请求将被丢弃
 - 基于请求限流
 - 基于资源限流
- 排队：（让用户等待一段时间）使用 Kafka 这类消息队列来缓存用户请求






