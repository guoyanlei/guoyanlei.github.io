

title: azkaban3.0使用记录
date: 2018/05/19 14:24:04
tags:
- azkaban
categories:
- azkaban

---

本文记录azkaban的安装和使用中遇到问题。

<!--more-->

### 安装

- Azkaban官网:https://azkaban.github.io
- 软件下载地址:https://github.com/azkaban/azkaban
- 官方插件地址:https://github.com/azkaban/azkaban-plugins
- 官方文档地址:http://azkaban.github.io/azkaban/docs/latest


#### 下载

```
git clone https://github.com/azkaban/azkaban.git
或 
wget https://codeload.github.com/azkaban/azkaban/zip/master
mv master azkaban.zip
unzip azkaban.zip
```

#### 编译

```
cd azkaban

./gradlew clean

./gradlew build

./gradlew installDist
  
--编译完成后
mkdir /data/dmp/azkaban

cd azkaban-solo-server/build/distributions
cp azkaban-solo-server-0.1.0-SNAPSHOT.tar.gz /data/dmp/azkaban

cd azkaban-exec-server/build/distributions
cp azkaban-exec-server-0.1.0-SNAPSHOT.tar.gz /data/dmp/azkaban

cd azkaban-web-server/build/distributions
cp azkaban-web-server-0.1.0-SNAPSHOT.tar.gz /data/dmp/azkaban

cd /data/dmp/azkaban
tar -zxvf azkaban-solo-server-0.1.0-SNAPSHOT.tar.gz
tar -zxvf azkaban-exec-server-0.1.0-SNAPSHOT.tar.gz
tar -zxvf azkaban-web-server-0.1.0-SNAPSHOT.tar.gz
mv azkaban-solo-server-0.1.0-SNAPSHOT azkaban-solo
mv azkaban-exec-server-0.1.0-SNAPSHOT azkaban-exec
mv azkaban-web-server-0.1.0-SNAPSHOT azkaban-web

```

#### 配置mysql表

```
--创建Azkaban数据库
create database azkaban;

use azkaban 

--创建Azkaban用户
CREATE USER 'azkaban'@'%' IDENTIFIED BY 'azkaban';

--赋权限
GRANT SELECT,INSERT,UPDATE,DELETE ON azkaban.* to 'azkaban'@'%' WITH GRANT OPTION;

source /data/dmp/create-all-sql-0.1.0-SNAPSHOT.sql

```

#### 配置conf

默认 web 和 exec下的是没有conf等文件的，需要从solo模式中拷贝过来

需要：

- azkaban.properties 
- azkaban-users.xml 
- global.properties 
- log4j.properties


web 和 exec下的azkaban.properties

```
zkaban Personalization Settings
azkaban.name=dmp
azkaban.label=azkaban 3.0
azkaban.color=#FF3601
azkaban.default.servlet.path=/index
web.resource.dir=/data/dmp/azkaban/azkaban-web/web/
default.timezone.id=Asia/Shanghai

# Azkaban UserManager class
user.manager.class=azkaban.user.XmlUserManager
user.manager.xml.file=/data/dmp/azkaban/azkaban-exec/conf/azkaban-users.xml

# Loader for projects
executor.global.properties=/data/dmp/azkaban/azkaban-exec/conf/global.properties
azkaban.project.dir=projects

database.type=mysql
mysql.port=3306
mysql.host=m1.mysql.bigdata.dmp.com
mysql.database=azkaban
mysql.user=azkaban
mysql.password=azkaban
mysql.numconnections=100

jetty.use.ssl=false
jetty.maxThreads=25
jetty.ssl.port=8443

jetty.keystore=/data/dmp/azkaban/keystore
jetty.password=azkaban
jetty.keypassword=azkaban
jetty.truststore=/data/dmp/azkaban/keystore
jetty.trustpassword=azkaban

# Velocity dev mode
velocity.dev.mode=false
# Azkaban Executor settings
executor.maxThreads=50
executor.port=12321
executor.flow.threads=30

# mail settings
mail.sender=xxx
mail.host=xxx
mail.user=xxx
mail.password=xxx
job.failure.email=xxx
job.success.email=xxx

# azkaban.webserver.external_hostname=myazkabanhost.com
# azkaban.webserver.external_ssl_port=443
# azkaban.webserver.external_port=8081

lockdown.create.projects=false
cache.directory=cache

# JMX stats
jetty.connector.stats=true
executor.connector.stats=true

# Azkaban plugin settings
azkaban.jobtype.plugin.dir=/data/dmp/azkaban/azkaban-exec/plugins/jobtypes


```

web 和 exec下的azkaban-users.xml

```
<azkaban-users>
  <user password="123" roles="admin" username="azkaban"/>
  <role name="admin" permissions="ADMIN"/>
  <role name="metrics" permissions="METRICS"/>
</azkaban-users>

```

web 和 exec下的log4j.properties

```
log4j.rootLogger=INFO,C
log4j.appender.C=org.apache.log4j.ConsoleAppender
log4j.appender.C.Target=System.err
log4j.appender.C.layout=org.apache.log4j.PatternLayout
log4j.appender.C.layout.ConversionPattern=%d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m%n

```

### 后台启动

```
nohup /data/dmp/azkaban/azkaban-web/bin/azkaban-web-start.sh > /data/dmp/azkaban/azkaban-web/azkaban-web.log &

nohup /data/dmp/azkaban/azkaban-exec/bin/azkaban-executor-start.sh > /data/dmp/azkaban/azkaban-exec/azkaban-exec.log &
```


### 使用系统环境变量

由于azkaban有自己的环境变量设置，因此若想通过$使用系统环境变量时，会读取不到，需要在azkaban中定义。

如使用azkaban执行下面的脚本时，若不配置会为空

```
#!/bin/sh

echo $SPARK2_HOME
echo $SPARK2_LIB_HOME
```

#### 原因

使用$与azkaban中的取法冲突，导致

#### 解决方法：

在azkaban-web的conf中的global.properties配置上需要的环境变量，然后重启azkaban即可。


```
-- global.properties
SPARK2_HOME=/data/dmp/cloudera/parcels/SPARK2/lib/spark2
SPARK2_LIB_HOME=/data/dmp/cloudera/parcels/SPARK2/lib/spark2/jars
```


