title: Hive-Mongo外部表使用记录
date: 2018/07/05 15:30:00
tags:
- hive
- mongodb
categories:
- hive

---


### 统计需求

需要在数据仓库中统计业务系统的数据，而这些数据存储在mongodb中，如何获取mongo中的数据并统计呢？下面记录下官网所提供的mongo-hadoop-hive方式来获取mongo中的数据。

官方：https://github.com/mongodb/mongo-hadoop/wiki/Hive-Usage


<!--more-->


### hive-mongo外部表

使用MongoStorageHandler实现hive-mongo外部表的映射，建表语句如下：

```
use business;
add jar hdfs://nameservice:8020/user/udf/mongo-hadoop-hive-1.5.1.jar;
add jar hdfs://nameservice:8020/user/udf/mongo-hadoop-core-1.5.1.jar;
add jar hdfs://nameservice:8020/user/udf/mongo-java-driver-3.2.2.jar;
create external table ods_dim_mongodb_volunteer_stat_info
(
    id                    bigint,
    date                  string,
    volunteer_nums        int,
    grap_totals           int,
    grap_success_totals   int,
    rescuit_success       int,
    avg_match             double,
    avg_new               double
)
STORED BY 'com.mongodb.hadoop.hive.MongoStorageHandler'
with SERDEPROPERTIES ('mongo.columns.mapping'='{"id":"_id","date":"date","volunteer_nums":"volunteerNums","grap_totals":"grapTotals","grap_success_totals":"grapSuccessTotals","rescuit_success":"rescuitSuccess","avg_match":"avgMatch","avg_new":"avgNew"}')
TBLPROPERTIES (
    'mongo.uri'='mongodb://{username}:{password}@{hostname}:27017/{db}.{collection}'
);

```

### 添加splitVector权限

创建外部表完毕后，在hive上进行查询时，报错如下：

```
not authorized on certificate to execute command 
{ splitVector: "certificate.certificate.access_log_test", 
  keyPattern: { _id: 1 }, 
  min: {}, 
  max: {}, 
  force: false, 
  maxChunkSize: 8 
}

```

#### 分析原因

- 线上mongo使用分片
- hive MongoStorageHandler 在拆分非分片集合时需要splitVector命令的，该命令仅限于管理员用户。mongo.input.split.create_input_splits的默认设置是true，也就是会对数据进行拆分，根据集群数，cpu核数然后将数据进行拆分成多个InputSplits,以允许Hadoop并行处理，也就是说，Hadoop为每个映射器分配一个InputSplits。

#### 解决方案

没有splitVector权限，则需要为该用户加上该权限

首先添加一个新role，并给予splitVector权限，之后把这个role分配至指定的user上。

```
# 添加角色
db.createRole(
    {
        role: "hadoopSplitVector",
        privileges: [
            {
                resource: {
                    db: "{db}",
                    collection: "{collection}"
                },
                actions: [
                    "splitVector"
                ]
            }
        ],
        roles:[]
    }
)

# 若需要对一个新的colletion添加splitVector权限，则只需更新角色即可
db.updateRole(
    "hadoopSplitVector",
    {
        privileges: [
            {
                resource: {
                    db: "suishen_lizhi",
                    collection: "wltt_invite_stats"
                },
                actions: [
                    "splitVector"
                ]
            },
            {
                resource: {
                    db: "suishen_lizhi",
                    collection: "volunteer_stat_info"
                },
                actions: [
                    "splitVector"
                ]
            },
        ],
        roles:[]
    }
)
```

```
# 更新用户
db.updateUser(
    "dmp",
    {
        roles: [
            {
                role:"read",
                db:"{db}"
            },
            {
                role:"hadoopSplitVector",
                db:"{db}"
            }
        ]
    }
)

# 若没有可用户用户可以创建一个只读用户
db.createUser(
    {
        user: "xxx",
        pwd: "xxx",
        roles: [ 
            { 
                role: "read", 
                db: "{db}" 
            } 
        ]
    }
)

```

注：上面添加更新用户、角色都需要较高权限的用户进行操作。

至此，已经可以使用外部表来查询mongo中的数据了。

### 查Mongo时'='的坑

在使用外部表查询mongo时，在条件中使用 where app = 'zhwnl'，发现查询的结果包含了其他的app，并不是我们限制的查询条件，这是因为MongoStorageHandler并没有将我们的'='转成mongo中的'$.eq'。

但是，我们可以'like'来解决，功能和'='等同。






