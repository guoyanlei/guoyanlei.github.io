

title: CentOS7.2-时间同步工具ntp&chrony
date: 2018/05/30 14:30:04
tags:
- kudu
- cloudera-manager
categories:
- cloudera-manager

---

### 背景

集群加了几台新节点，安装了Cloudera之后，总是提示：

- 不良 : 无法找到主机的 NTP 服务，或该服务未响应时钟偏差请求。

但是，ntpd服务明明开启了，而且连接正常，还是提示时钟偏差。

最终调研了chronyd，发现CentOS7.2已经推荐使用chronyd，因此试着改为chronyd，重启Cloudera agent后问题解决了。下面总结下chronyd时钟同步。

<!--more-->

### chronyd

Chrony是网络时间协议的 (NTP) 的另一种实现。一直以来众多发行版里标配的都是ntpd对时服务，自rhel7/centos7 起，Chrony做为了发行版里的标配服务，不过老的ntpd服务依旧在rhel7/centos7里可以找到。

Chrony可以同时做为ntp服务的客户端和服务端。默认安装完后有两个程序chronyd和chronyc。

- chronyd是一个在系统后台运行的守护进程
- chronyc是用来监控chronyd性能和配置其参数程序

#### 安装

```
# yum install -y chrony              //安装服务
# systemctl start chronyd.service    //启动服务
# systemctl enable chronyd.service   //设置开机自启动，默认是enable的

```

#### chrony.conf配置

Chrony的配置在/etc/chrony.conf，其个是ntpd服务基本相同，主要包含了：

```
# 时钟服务器，通过prefer提高优先级
server 10.9.141.12 iburst minpoll 3 maxpoll 4 prefer
server 10.9.255.1 iburst minpoll 3 maxpoll 4 
server 10.9.255.2 iburst minpoll 3 maxpoll 4 

# 设置当chronyd从可用源中选择同步源时，每个层应该添加多少距离到同步距离。默认情况下，CentOS中设置为0，让chronyd在选择源时忽略源的层级
stratumweight 0

#chronyd程序的主要行为之一，就是根据实际时间计算出计算机增减时间的比率，将它记录到一个文件中是最合理的，它会在重启后为系统时钟作出补偿，甚至可能的话，会从时钟服务器获得较好的估值；
driftfile /var/lib/chrony/drift

#rtcsync指令将启用一个内核模式，在该模式中，系统时间每11分钟会拷贝到实时时钟（RTC）
rtcsync

#chronyd将根据需求通过减慢或加速时钟，使得系统逐步纠正所有时间偏差。
makestep 10 3

#允许你限制chronyd监听哪个网络接口的命令包
bindcmdaddress 127.0.0.1
bindcmdaddress ::1

keyfile /etc/chrony.keys
commandkey 1
generatecommandkey
noclientlog
logchange 0.5
logdir /var/log/chrony
```

#### ntpd改到chronyd

```
1. 停掉所有ntpd服务，停止自启动ntpd服务
systemctl stop ntpd.service
systemctl disable ntpd.service
vim /etc/chrony.conf

2. 注释掉已有server，添加roc-master的server
server 192.168.1.2 iburst  # 这里的ip地址是NTP服务器地址

3.重启服务
systemctl enable chronyd.service -l
systemctl restart chronyd.service -l
systemctl status chronyd.service -l
chronyc sourcestats
chronyc sources -v
```

#### chronyd改到ntpd

```
systemctl disable chronyd.service -l
systemctl stop chronyd.service -l
systemctl status chronyd.service -l
systemctl restart ntpd.service
systemctl status ntpd.service
ntpq -p
ntpstat
```

#### 状态检测

```
# chronyd
systemctl status chronyd.service -l
chronyc sourcestats
chronyc sources -v

# ntpd
systemctl status ntpd.service -l
ntpq -p
ntpstat

# 是否在系统级别得到时间同步：
timedatectl
```

#### chrony的优势

- 更快的同步只需要数分钟而非数小时时间，从而最大程度减少了时间和频率误差，这对于并非全天 24 小时运行的台式计算机或系统而言非常有用。
- 能够更好地响应时钟频率的快速变化，这对于具备不稳定时钟的虚拟机或导致时钟频率发生变化的节能技术而言非常有用。
- 在初始同步后，它不会停止时钟，以防对需要系统时间保持单调的应用程序造成影响。
- 在应对临时非对称延迟时（例如，在大规模下载造成链接饱和时）提供了更好的稳定性。
- 无需对服务器进行定期轮询，因此具备间歇性网络连接的系统仍然可以快速同步时钟。


