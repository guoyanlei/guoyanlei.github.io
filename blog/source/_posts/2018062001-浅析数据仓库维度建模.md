title: 浅析数据仓库维度建模
date: 2018/06/20 15:30:00
tags:
- 数据仓库
- 维度建模
categories:
- 数据仓库

---

### 维度建模基础

#### 维度 & 维度属性

维度是维度建模的基础和灵魂，在维度建模中，将度量称为“事实”，将环境描述为“维度”，维度是用来分析事实所需要的多样环境。

如：将用户交易数据看做一个“事实”，可通过买家、卖家、商品和时间等多个维度来描述整个交易过程所发生的环境。

维度所包含的表示维度的列，称为维度属性。维度属性是查询约束条件（where）、分组（group by）和报表标签生成的基本来源。


<!--more-->


#### 下钻 & 上钻（上卷）

维度中的属性有时会以层次方式或一对多的方式相互关联，层次的最底层代表维度中描述最低级别的详细信息，最高层代表最高级别的概要信息。在属性的层次结构中进行钻取是数据钻取的方法之一。

沿着属性层次，往下即为下钻（drill down），往上可称上钻或上卷（roll up）。

如：地区维度，从全球到地区到国家到省份到市到县，层层下钻。第一级别可以根据需求而定。我看到上海市的总数，想要看各个区的数据，就用下钻。

对多维数据进行分析时还会用到：

- 旋转(pivot)，是维度的切换，换个角度看问题

- 切片(slice)，查看数据的时候，通常是不会所有维度都用到的，选择某两个维度进行分析，可以想象为一个二维平面，即切片。

- 切块，即选出3个维度时，切出来的自然就时块了。

至此，就可以理解OLAP中的CUBE等相关概念了。

#### 规范化（OLTP）& 反规范化（OLAP）

将属性层次设计成数据库表时，规范化可以将重复属性移至其自身所属的表中，删除冗余数据，还可以有效避免数据冗余导致的不一致性。规范化常用在大多数联机事务处理系统(OLTP)的底层数据结构设计中。

当属性层次被实例化为一系列维度，而不是单一的维度时，被称为雪花模式，常出现在OLTP中。

而对于联机分析处理系统(OLAP)来说，数据是稳定的，不存在OLTP中所存在的问题。因此，在设计时常采用反规范化处理，从用户角度来看简化了模型，并且使数据库查询优化器的连接路径比完全规范化的模型简化许多。

#### 一致性维度 & 交叉探查

企业级数据仓库等构建不可能一蹴而就，一般采用迭代式的构建过程。 而单独构建存在的问题是形成独立型数据集市，导致严重的不一致性。

Kimball的数据仓库总线架构：提供了一种分解企业级数据仓库规划任务的合理方法，通过构建企业范围内一致性维度和事实来构建总线架构。

如：对于日志数据域，统计了商品维度的最近一天的PV和UV; 对于交易数据域，统计了商品维度的最近一天的下单量。

现在将不同数据域的商品的事实合并在一起进行数据探查，如计算转化率等，称为交叉探查。

不用数据域的维度可能会存在不一致的问题，为避免这一问题，可通过以下方式保证维度一直性：

- 共享维表：基于共享维表进行交叉探查
- 一致性上卷：可以在两个维度相同的上层属性上，交叉探查
- 交叉属性：可在两个维度相同的属性上，交叉探查


### 维度建模

#### 维度整合 & 拆分

- 垂直整合：不同的来源表包含相同的数据集
- 水平整个：不同的来源表包含不同的数据集

如：会员在源系统中可能有多个表，会员基础信息表、会员扩展信息表、会员等级信息表等，这些表都属于会员相关信息表，应尽量整合至会员维度模型中，即垂直整合。

如：对与淘宝的会员体系，分为支付宝会员、淘宝会员等，这这些会员进行整合时即水平整合，整合时需要考虑各个会员体系是否有交叉，如果存在交叉，则需要去重；如果不存在交叉，则需要考虑不同子集的自然键是否存在冲突，冲突时可添加分区字段来处理。

有整合就会有拆分，维度是维度建模的基础和灵魂，在进行维度设计时，依据维度设计的原则，尽可能丰富维度属性，同时进行反规范化处理。

#### 维度变化

如何处理维度的变化是维度设计的重要工作之一。

##### 缓慢变化维

在现实世界中，维度的属性并不是静态的，它会随着时间的流逝发生缓慢的变化。与数据增长较为快速的事实表相比，维度变化相对缓慢。

在一些情况下，保留历史数据没有什么分析价值；而在另一些情况下，保留历史数据将会起到至关重要的作用。有三种方式处理缓慢变化维：

- 重写维度值：不会保留历史，始终取最新的数据
- 插入新的维度行：保留历史数据，老的事实与老的维度值关联，新的与新的关联，不能将变化前后的事实归一化为变化前的维度或变化后的维度
- 添加维度列(新属性)：保留历史数据，可解决变化前后的事实按变化前后的维度归一化问题

##### 快照维表

处理缓慢变化维的方法可以采用快照方式，即基于某一周期（天），处理维度变化的方式就是每天保留一份全量快照数据。

优：简单有效，开发维护成本低；使用方便，理解性好。
缺：存储极大浪费，必须要有对应的数据生命周期制度，清除无用的历史数据。

##### 拉链表

采用插入新的维度行的思想，处理方式：通过新增两个时间戳字段(start_dt和end_dt)，将所有以天为粒度的变更数据都记录下来。

拉链记历史，不需要按周期把所有数据都快照存储，只需要将发生变化的数据添加新的存储。

在查询数据时，可通过限制时间戳字段来获取历史数据。

缺：理解较困难，另外，以start_dt和end_dt做分区，一年的可能产生的分区数：365 x 364/2 = 66430个，随着时间推移，会使得分区数极度膨胀，超过分区数限制。


##### 拉链表升级之极限存储

底层基于拉链表，上层做一个视图，对下游使用者做到透明。同时，缓解分区数极度膨胀导致存储查询代价较大的问题。

优化的根源在于分区数，只需每月多一次拉链计算，就能优化十倍的性能。

##### 微型维度

通过将一部分不稳定的属性从主维度中移出，并将它们放置到拥有自己代理键的新表中。

如：用户的注册日期、年龄、性别的信息基本不会变化，但是用户等级却在不断变化，可将其独立开来。

缺：实现代价较高，ETL逻辑复杂，破坏了维度的可浏览性。



【参考】

[之前的维度建模分享](http://tech.weli.cn/2017/12/29/dataware-intro/)

[拉链表与极限存储](http://www.zdingke.com/2018/05/24/%E6%8B%89%E9%93%BE%E8%A1%A8%E4%B8%8E%E6%9E%81%E9%99%90%E5%AD%98%E5%82%A8/)







