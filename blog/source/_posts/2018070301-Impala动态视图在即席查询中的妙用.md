title: Impala动态视图在即席查询中的妙用
date: 2018/07/03 15:30:00
tags:
- impala
categories:
- impala

---


### 查询视图

视图仅仅是存储在数据库中具有关联名称的Impala查询语言的语句。 它是以预定义的SQL查询形式的表的组合。视图可以包含表的所有行或选定的行。 可以从一个或多个表创建视图。

创建视图没什么难度，这里总结下是视图在我们Ad-Hoc查询是怎么用的。


<!--more-->


### Ad-Hoc即席查询

即席查询是用户根据自己的需求，灵活的选择查询条件，系统能够根据用户的选择生成相应的统计报表。即席查询与普通应用查询最大的不同是普通的应用查询是定制开发的，而即席查询是由用户自定义查询条件的。

基于数据仓库中事实表的设计，我们的Ad-Hoc简单的架构如下图：

![Ad-Hoc架构](/img/impala/ad-hoc-query.png)

架构比较简单，主要借助Impala + parquet去查询HDFS中的数据，并借助kudu接收实时写入的数据，

在T+1日后，会将kudu中实时写入的数据转存到HDFS中，并转换成parquet格式。

Parquet存储格式

- 按列存储
- 可按时间分许
- 局部排序
- 只支持批量写入，无法追加，无法实时写入

Kudu：新一代面向实时分析的存储引擎

- 底层使用类似Parquet的存储结构
- 支持实时写入，实时更新，实时查询
- 扫描性能比Parquet略差


### 动态视图的使用

下面介绍动态视图的使用，结合上面说的，我们有时候即需要查询hive中T-1的历史数据，又要查询今天实时写入的数据，怎么实现呢？

Impala就可以帮助我们，即可以查询Hive又可以查询Kudu，但是每次我们都需要判断日期是不是今天，来判断要不要查kudu中的数据，因此就想到了视图，并结合Union all来实现。ok，到这这里就下面的视图创建语句。

```
create view prod.ods_view_pv_event_1d as
select xxx
      ,xxx
  from prod.ods_hive_pv_event_1d
 where ds <= '20180704'
 union all
select xxx
      ,xxx
  from prod.ods_kudu_pv_event_1d
 where nginx_date = '20180705'
;
```

虽然视图创建成功，也满足了对于20180705的需求，但是如果过了这一天，20180706应该怎么查呢，还需要再创建一个视图？

其实，我们可以如下这么做，下面的语句只是将上面写死的日期改成了可根据now()动态的日期。这样我们就不需要每次使用的时候创建一个视图了。

主要是视图，并不是数据库中以存储的数据值集形式存在，而仅仅是存储在数据库中具有关联名称的查询语句！！（这一点需要仔细参悟，自己当时就想了很久）

```
create view prod.ods_view_pv_event_1d as
select xxx
      ,xxx
  from prod.ods_hive_pv_event_1d
 where ds <= from_timestamp(date_sub(now(), 1),'yyyyMMdd')
 union all
select xxx
      ,xxx
  from prod.ods_kudu_pv_event_1d
 where nginx_date = from_timestamp(now(),'yyyyMMdd')
;

```






