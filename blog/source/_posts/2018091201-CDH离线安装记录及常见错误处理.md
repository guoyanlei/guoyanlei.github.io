title: CDH离线安装记录及常见错误处理
date: 2018/09/11 15:30:00
tags:
- cloudera-manager
categories:
- cloudera-manager

---

### 准备安装包

[cloudera manager下载地址](http://archive.cloudera.com/cm5/cm/5/)

[CDH下载地址](http://archive.cloudera.com/cdh5/parcels/5.12.2/)选择自己合适的版本

[manifest.json下载地址](http://archive.cloudera.com/cdh5/parcels/5.12.2/manifest.json)

<!--more-->

### 网络配置

对于集群中搜索节点都需要做：

1. 修改主机名称
2. 关闭防火墙

### 配置免密码登陆

对于集群中所有节点，任意两个节点实现免密码登陆。并且开启ssh服务。

### 安装jdk

对于集群中节点安装jdk，可以自己安装，也可以通过cloudera manager安装。安装完成之后，配置`JAVA_HOME`。对于线上，建议自己安装。

### 安装和配置NTP服务

cloudera manager通过ntp服务，保持集群内的时钟同步。时钟偏差会应用服务，特别是kudu，因为kudu的事务需要以来时钟一致。

安装NTP
```
yum install ntp
```

集群内，建议在集群内做一个NTP服务器，作为优先级最高的NTP服务器，其它的作为备用。

手动同步可以如下命令：
```
ntpdate -d NTP服务器的host或者IP
```

可以通过如下命令查看NTP的统计
```
ntpstat
```

还可以通过ntpq查看ntp服务同步各个服务器的情况

```
ntpq -p
```

若系统是CentOS7的同步时钟的方式建议使用chrony，[将ntp切换为chrony参考之前的文章](http://guoyanlei.top/2018/05/30/2018053001-CentOS7.2-%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7ntp&chrony/)

### 准备MySQL

cloudera-manager、hive、hue、oozie都需要MySQL来存储元数据。所以需要提前准备好一台MySQL。

对于不同不同的服务，采用不同的kudu，不同的用户，进行授权。



### 安装依赖

通过yum安装cloudera-manager的依赖，命令如下：

```
yum -y install chkconfig
yum -y install bind-utils
yum -y install psmisc
yum -y install libxslt
yum -y install zlib
yum -y install sqlite
yum -y install cyrus-sasl-plain
yum -y install cyrus-sasl-gssapi
yum -y install fuse
yum -y install portmap
yum -y install fuse-libs
yum -y install redhat-lsb

```

### 安装cloudera manager server

  1. 在cloudera manager server所在节点创建cloudera-manager安装目录

    ```
    mkdir -p /data/dmp/cloudera-manager
    ```

  2. 将下载好的cloudera-manager安装包cloudera-manager-centos7-cm5.12.2_x86_64.tar.gz解压放在改目录：

    ```
    tar -zxvf cloudera-manager-centos7-cm5.12.2_x86_64.tar.gz -C /data/dmp/cloudera-manager
    ```

   3. 创建`cloudera-scm`用户

   Cloudera管理器服务器和托管服务被配置为在默认情况下使用用户帐户Cloudera-scm，创建具有这个名称的用户是最简单的方法。创建用户，在安装完成后自动使用。

   执行如下命令：

    ```
    useradd --system --home=/data/dmp/cloudera-manager/cm-5.12.2/run/cloudera-scm-server/ --no-create-home --shell=/bin/false --comment "Cloudera SCM User" cloudera-scm
    ```

  4. 下载MySQL驱动

    ```
    cd  /data/dmp/cloudera-manager/cm-5.12.2/share/cmf/lib

    wget http://maven.aliyun.com/nexus/service/local/repositories/hongkong-nexus/content/Mysql/mysql-connector-java/5.1.38/mysql-connector-java-5.1.38.jar
    ```

  5. 配置cloudera manager server的数据库

  进入cloudera-manager安装目录下的`cm-5.12.2/share/cmf/schema/`目录中，找到`scm_prepare_database.sh`，这个脚本是执行cloudera-amanger数据库初始化的脚本。

    ```
    cd /data/dmp/cloudera-manager/cm-5.12.2/share/cmf/schema/

    ./scm_prepare_database.sh mysql cm -h ${MySQL节点的host或者ip} -u${MySQL用户} -p${MySQL密码} --scm-host ${cloudera manager server的ip或者host} scm scm scm
    ```

   看到如下信息，就配置成功

    ```
    [main] DbCommandExecutor              INFO  Successfully connected to database.
    All done, your SCM database is configured correctly!

    ```

  格式

    ```
    scm_prepare_database.sh mysql cm -h <hostName> -u<username>  -p<password> --scm-host <hostName>  scm scm scm

    对应于：数据库类型  数据库 服务器 用户名 密码  –scm-host  Cloudera_Manager_Server 所在节点……

    ```

  6. Manager节点上创建Parcel目录

   (1). 创建目录`/data/dmp/cloudera/parcel-repo`，并且将该目录授权给cloudera-scm用户，执行命令：

    ```
    mkdir -p /data/dmp/cloudera/parcel-repo

    chown cloudera-scm:cloudera-scm /data/dmp/cloudera/parcel-repo
    ```

   (2) 将爱在好的parcel复制到`/data/dmp/cloudera/parcel-repo`目录下，parcel列表

    ```
        CDH-5.12.2-1.cdh5.12.2.p0.4-el7.parcel
        CDH-5.12.2-1.cdh5.12.2.p0.4-el7.parcel.sha
        manifest.json
        KUDU-1.4.0-1.cdh5.12.2.p0.8-el7.parcel
        KUDU-1.4.0-1.cdh5.12.2.p0.8-el7.parcel.sha

    ```
   注意，需要将`CDH-5.12.2-1.cdh5.12.2.p0.4-el7.parcel.sha1`重命名为`CDH-5.12.2-1.cdh5.12.2.p0.4-el7.parcel.sha`，否则系统会重新下载。




### 安装cloudera-manager的agent

对于通过cloudera-manager管理的主机，都需要安装agent，cloudera-manager的安装软件和监控都是通过agent完成的。所有加入的节点，都需要cloudera-manager的server节点保持通信，实现ssh免密码登陆。

头3步和cloudera manager server节点相同

  1. 在cloudera manager server所在节点创建cloudera-manager安装目录

    ```
    mkdir -p /data/dmp/cloudera-manager
    ```

  2. 将下载好的cloudera-manager安装包cloudera-manager-centos7-cm5.12.2_x86_64.tar.gz解压放在改目录：

    ```
    tar -zxvf cloudera-manager-centos7-cm5.12.2_x86_64.tar.gz -C /data/dmp/cloudera-manager
    ```

  3. 创建`cloudera-scm`用户

   Cloudera管理器服务器和托管服务被配置为在默认情况下使用用户帐户Cloudera-scm，创建具有这个名称的用户是最简单的方法。创建用户，在安装完成后自动使用。

  执行如下命令：

    ```
    useradd --system --home=/data/dmp/cloudera-manager/cm-5.12.2/run/cloudera-scm-server/ --no-create-home --shell=/bin/false --comment "Cloudera SCM User" cloudera-scm
    ```

  4. 配置agent

  在`/data/dmp/cloudera-manager/cm-5.12.2/etc/cloudera-scm-agent/config.ini`中可以pacel、各个服务的安装目录、cloudera-manager server的地址。


  5. 创建parcels目录

  在agent节点上，创建`/data/dmp/cloudera/parcels`，并且将改目录用户组授权给cloudera-scm

    ```
    mkdir -p /data/dmp/cloudera/parcels

    chown cloudera-scm:cloudera-scm /data/dmp/cloudera/parcels
    ```

### 启动服务

  1. 在manager节点启动cloudera-scm-server服务。执行命令:

    ```
    /data/dmp/cloudera-manager/cm-5.12.2/etc/init.d/cloudera-scm-server start
    ```

  2. 在agent节点启动agent

    ```
    /data/dmp/cloudera-manager/cm-5.12.2/etc/init.d/cloudera-scm-agent start
    ```

### 登陆cloudera manager安装服务

访问cloudera manager server节点的7180端口，这里的地址`http://cloudera-manager.etouch.cn/cmf/login`

通过用户名和密码登陆，默认的用户名和密码都是admin。

安装提示一步一步进行配置，在安装会有机器监测，对于监测的问题，cloudera manager会有提示，提示如何修改。

#### 向集群添加安装新的节点agent
```shell
mkdir -p /data/dmp/cloudera-manager
tar -zxvf cloudera-manager-centos7-cm5.12.2_x86_64.tar.gz -C /data/dmp/cloudera-manager

useradd --system --home=/data/dmp/cloudera-manager/cm-5.12.2/run/cloudera-scm-server/ --no-create-home --shell=/bin/false --comment "Cloudera SCM User" cloudera-scm

cd /data/dmp/cloudera-manager/cm-5.12.2/etc/cloudera-scm-agent
rm -f config.ini

scp /data/dmp/cloudera-manager/cm-5.12.2/etc/cloudera-scm-agent/config.ini root@node104.bigdata.dmp.local.com:/data/dmp/cloudera-manager/cm-5.12.2/etc/cloudera-scm-agent/config.ini

mkdir -p /data/dmp/cloudera/parcels
chown cloudera-scm:cloudera-scm /data/dmp/cloudera/parcels
```

### Cloudera Manager安装常见错误和脚本

#### 1. 防火墙和selinux关闭
- 出现连接拒绝，用telnet测试相关端口，server：7180、agent：7182

#### 2. CM agent的日志在/data/dmp/log下面
- 新装agent起不来，可能需要手动创建相关文件夹。见：http://community.cloudera.com/t5/Cloudera-Manager-Installation/Failed-to-receive-heartbeat-from-agent-CM-server-guid/m-p/64228













